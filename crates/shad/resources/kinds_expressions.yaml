max_u32: &max_u32 4294967295
no_return_type_name: &no_return_type_name '<no return>'

kinds:
  expr:
    sequence: [ expr_choice ]
    sequence_error_after: expr_choice
    validation:
      - name: check_invalid_expr_type
        params: { type: *no_return_type_name }
    transpilation: '{{child:expr_choice}}'

  expr_choice:
    choice: [ true_expr, false_expr, fn_call_expr, var_ident_expr, f32_expr, u32_expr, i32_expr ]

  var_ident_expr:
    sequence: [ ident ]
    sequence_error_after: ident
    index_key_source:
      key:
        - string: '`'
        - slice: true
        - string: '` variable'
      criteria:
        - kind: local_var_def_stmt
          can_be_after: false
        - kind: fn_param
          can_be_after: false
          allowed_siblings:
            - parent_index: 1 # `fn_item` node
              child_offset: 4 # `fn_param_group` child node
        - kind: buffer_item
          can_be_after: false
    validation:
      - name: check_existing_source
        params: { }
    type_resolution:
      source_children: [ expr, param_type ]
    transpilation: '_{{source_id}}'

  fn_call_expr:
    sequence: [ ident, open_parenthesis, fn_arg_group, close_parenthesis ]
    sequence_error_after: open_parenthesis
    index_key_source:
      key:
        - string: '`'
        - slice_child: ident
        - string: '('
        - type_nested_child: fn_arg
          separator: ', '
        - string: ')` function'
      criteria:
        - kind: fn_item
          can_be_after: true
    validation:
      - name: check_existing_source
        params: { }
    transpilation: '_{{source_id}}({{child:fn_arg_group}})'
    type_resolution:
      source_children: [ fn_return_type ]

  fn_arg_group:
    min_repeat: 0
    max_repeat: 1
    sequence: [ fn_arg, fn_other_args, fn_args_final_comma ]
    sequence_error_after: fn_arg
    transpilation: '{{child:fn_arg}}{{child:fn_other_args}}'

  fn_arg:
    sequence: [ expr ]
    sequence_error_after: expr
    transpilation: '{{child:expr}}'

  fn_other_args:
    min_repeat: 0
    max_repeat: *max_u32
    sequence: [ comma, fn_arg ]
    sequence_error_after: fn_arg
    transpilation: ', {{child:fn_arg}}'

  fn_args_final_comma:
    min_repeat: 0
    max_repeat: 1
    sequence: [ comma ]
    sequence_error_after: comma

  f32_expr:
    pattern_parts:
      - char_ranges:
          - { start: '-', end: '-' }
        min_length: 0
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
        min_length: 1
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
          - { start: '_', end: '_' }
        min_length: 0
        max_length: *max_u32
      - char_ranges:
          - { start: '.', end: '.' }
        min_length: 1
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
        min_length: 1
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
          - { start: '_', end: '_' }
        min_length: 0
        max_length: *max_u32
    display_name: '`f32` literal'
    validation:
      - name: check_number_range
        params: { type: f32, removed_chars: '_' }
    type_resolution:
      name: f32
    transpilation: 'f32({{slice_without_chars:_}})'

  u32_expr:
    pattern_parts:
      - char_ranges:
          - { start: '0', end: '9' }
        min_length: 1
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
          - { start: '_', end: '_' }
        min_length: 0
        max_length: *max_u32
      - char_ranges:
          - { start: 'u', end: 'u' }
        min_length: 1
        max_length: 1
    display_name: '`u32` literal'
    validation:
      - name: check_number_range
        params: { type: u32, removed_chars: '_u' }
    type_resolution:
      name: u32
    transpilation: 'u32({{slice_without_chars:_}})'

  i32_expr:
    pattern_parts:
      - char_ranges:
          - { start: '-', end: '-' }
        min_length: 0
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
        min_length: 1
        max_length: 1
      - char_ranges:
          - { start: '0', end: '9' }
          - { start: '_', end: '_' }
        min_length: 0
        max_length: *max_u32
    display_name: '`i32` literal'
    validation:
      - name: check_number_range
        params: { type: i32, removed_chars: '_' }
    type_resolution:
      name: i32
    transpilation: 'i32({{slice_without_chars:_}})'

  true_expr:
    string: 'true'
    type_resolution:
      name: bool
    transpilation: 'u32(true)'

  false_expr:
    string: 'false'
    type_resolution:
      name: bool
    transpilation: 'u32(false)'
